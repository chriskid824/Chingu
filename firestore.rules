rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // --- Helper Functions ---

    // Check if user is authenticated
    function isAuthenticated() {
      return request.auth != null;
    }

    // Check if the user is the owner of the document (by uid)
    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }

    // Check if user is an admin
    // Validates against a hardcoded email (for dev/test) or an 'isAdmin' flag on the user document.
    // Note: We use .get('isAdmin', false) to safely handle cases where the field is missing.
    function isAdmin() {
      return isAuthenticated() && (
        (request.auth.token.email == 'test@gmail.com' && request.auth.token.email_verified) ||
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.get('isAdmin', false) == true
      );
    }

    // --- Users Collection ---
    // Read: Authenticated users can read profiles.
    // WARNING: This exposes all fields in the user document (including email/phone if stored there) to any authenticated user.
    // Ideally, sensitive data should be in a private subcollection or filtered via a dedicated public profile collection.
    // Given the current architecture, we must allow read for matching/chat to function.
    //
    // Write: Owner can create/update.
    // CRITICAL SECURITY: We explicitly prevent users from modifying the 'isAdmin' field to prevent privilege escalation.
    match /users/{userId} {
      allow read: if isAuthenticated();
      allow create: if isOwner(userId) &&
        (!request.resource.data.keys().hasAny(['isAdmin'])); // Prevent setting isAdmin on creation

      allow update: if (isOwner(userId) &&
        (!request.resource.data.diff(resource.data).affectedKeys().hasAny(['isAdmin'])) // Prevent modifying isAdmin
      ) || isAdmin(); // Admin can update anything

      allow delete: if isOwner(userId) || isAdmin();

      // Subcollection: login_history
      match /login_history/{historyId} {
         allow read: if isOwner(userId) || isAdmin();
         allow create: if isOwner(userId);
      }
    }

    // --- Chat Rooms ---
    // Read/Write: Only participants of the chat room.
    match /chat_rooms/{chatRoomId} {
      allow read: if isAuthenticated() && (request.auth.uid in resource.data.participantIds);
      allow create: if isAuthenticated() && (request.auth.uid in request.resource.data.participantIds);
      allow update: if isAuthenticated() && (request.auth.uid in resource.data.participantIds);
    }

    // --- Messages ---
    // Messages are stored in a root collection 'messages'.
    // Security relies on checking the 'chatRoomId' field and verifying membership in that room.
    match /messages/{messageId} {
      // Read: User must be a participant of the chat room referenced by chatRoomId.
      allow read: if isAuthenticated() && (
        request.auth.uid in get(/databases/$(database)/documents/chat_rooms/$(resource.data.chatRoomId)).data.participantIds
      );

      // Create: User must be a participant of the target chat room and senderId must match auth.uid.
      allow create: if isAuthenticated() &&
        (request.auth.uid in get(/databases/$(database)/documents/chat_rooms/$(request.resource.data.chatRoomId)).data.participantIds) &&
        request.resource.data.senderId == request.auth.uid;

      // Update/Delete: Only the sender can modify their own messages.
      allow update: if isAuthenticated() && resource.data.senderId == request.auth.uid;
      allow delete: if isAuthenticated() && resource.data.senderId == request.auth.uid;
    }

    // --- Dinner Events ---
    // Read: Public/Authenticated.
    // Create: Authenticated users.
    // Update/Delete: Creator or Admin.
    match /dinner_events/{eventId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated();
      allow update: if isAuthenticated() && (resource.data.creatorId == request.auth.uid || isAdmin());
      allow delete: if isAuthenticated() && (resource.data.creatorId == request.auth.uid || isAdmin());
    }

    // --- Swipes ---
    // Used for matching logic.
    // Read: User can read their own swipes, or swipes where they are the target (to check for mutual matches).
    match /swipes/{swipeId} {
       allow read: if isAuthenticated() && (
         resource.data.userId == request.auth.uid ||
         resource.data.targetUserId == request.auth.uid
       );
       allow create: if isAuthenticated() && request.resource.data.userId == request.auth.uid;
       allow delete: if isAuthenticated() && resource.data.userId == request.auth.uid;
    }

    // --- Reports ---
    // Create: Authenticated users.
    // Read/Update: Admin only.
    match /reports/{reportId} {
      allow create: if isAuthenticated();
      allow read: if isAdmin();
      allow update: if isAdmin();
    }

    // --- Feedback ---
    // Create: Authenticated users.
    // Read: Admin only.
    match /feedback/{feedbackId} {
      allow create: if isAuthenticated();
      allow read: if isAdmin();
    }

    // --- Notification Stats ---
    // Read: Admin only.
    // Write: Authenticated users (if client-side tracking).
    match /notification_stats/{statId} {
      allow read: if isAdmin();
      allow write: if isAuthenticated();
    }

    // --- User Blocks ---
    // Read: Blocker or Blocked user (to filter out blocked users).
    // Write: Blocker only.
    match /user_blocks/{blockId} {
      allow read: if isAuthenticated() && (
        resource.data.blockerId == request.auth.uid ||
        resource.data.blockedUserId == request.auth.uid
      );
      allow create: if isAuthenticated() && request.resource.data.blockerId == request.auth.uid;
      allow delete: if isAuthenticated() && resource.data.blockerId == request.auth.uid;
    }

    // --- Two Factor Codes ---
    // Completely private, accessible only via backend (Admin SDK).
    match /two_factor_codes/{codeId} {
      allow read, write: if false;
    }

    // --- Moments ---
    // User posts.
    match /moments/{momentId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated() && request.resource.data.userId == request.auth.uid;
      allow update: if isAuthenticated() && resource.data.userId == request.auth.uid;
      allow delete: if isAuthenticated() && (resource.data.userId == request.auth.uid || isAdmin());
    }
  }
}
