import 'package:chingu/models/notification_model.dart';
import 'package:chingu/models/user_model.dart';
import 'package:chingu/services/firestore_service.dart';
import 'package:chingu/services/notification_storage_service.dart';

/// é€šçŸ¥æœå‹™
/// è² è²¬å”èª¿é€šçŸ¥çš„ç”Ÿæˆèˆ‡ç™¼é€é‚è¼¯
class NotificationService {
  final NotificationStorageService _notificationStorageService;
  final FirestoreService _firestoreService;

  NotificationService({
    NotificationStorageService? notificationStorageService,
    FirestoreService? firestoreService,
  })  : _notificationStorageService =
            notificationStorageService ?? NotificationStorageService(),
        _firestoreService = firestoreService ?? FirestoreService();

  /// ç™¼é€é…å°é€šçŸ¥çµ¦é›™æ–¹
  Future<void> sendMatchNotifications({
    required String user1Id,
    required String user2Id,
  }) async {
    try {
      // 1. ç²å–ç”¨æˆ¶è³‡æ–™
      final UserModel? user1 = await _firestoreService.getUser(user1Id);
      final UserModel? user2 = await _firestoreService.getUser(user2Id);

      if (user1 == null || user2 == null) {
        print('Error sending match notifications: one or both users not found.');
        return;
      }

      // 2. æ§‹å»ºä¸¦ç™¼é€çµ¦ User 1 çš„é€šçŸ¥ (å‘Šè¨´ä»–è·Ÿ User 2 é…å°äº†)
      final notificationForUser1 = NotificationModel(
        id: '', // ID will be generated by Firestore
        userId: user1Id,
        type: 'match',
        title: 'æ–°é…å°æˆåŠŸ! ğŸ‰',
        message: 'ä½ èˆ‡ ${user2.name} é…å°æˆåŠŸäº†ï¼å¿«å»æ‰“å€‹æ‹›å‘¼å§',
        imageUrl: user2.avatarUrl, // ä½¿ç”¨å°æ–¹çš„é ­åƒ
        actionType: 'open_chat',
        actionData: user2Id, // å‚³éå°æ–¹ IDï¼Œä»¥ä¾¿è·³è½‰
        isRead: false,
        createdAt: DateTime.now(),
      );

      await _notificationStorageService.sendNotificationToUser(
        user1Id,
        notificationForUser1,
      );

      // 3. æ§‹å»ºä¸¦ç™¼é€çµ¦ User 2 çš„é€šçŸ¥ (å‘Šè¨´ä»–è·Ÿ User 1 é…å°äº†)
      final notificationForUser2 = NotificationModel(
        id: '',
        userId: user2Id,
        type: 'match',
        title: 'æ–°é…å°æˆåŠŸ! ğŸ‰',
        message: 'ä½ èˆ‡ ${user1.name} é…å°æˆåŠŸäº†ï¼å¿«å»æ‰“å€‹æ‹›å‘¼å§',
        imageUrl: user1.avatarUrl, // ä½¿ç”¨å°æ–¹çš„é ­åƒ
        actionType: 'open_chat',
        actionData: user1Id,
        isRead: false,
        createdAt: DateTime.now(),
      );

      await _notificationStorageService.sendNotificationToUser(
        user2Id,
        notificationForUser2,
      );

      print('Match notifications sent to $user1Id and $user2Id');
    } catch (e) {
      print('Error sending match notifications: $e');
      // ä¸æ‹‹å‡ºç•°å¸¸ï¼Œä»¥å…ä¸­æ–·é…å°æµç¨‹
    }
  }
}
